#!/usr/bin/env node
"use strict";var validateArgs={block:Boolean,chars:String,height:Number,htmlColor:Boolean,invert:Boolean,opacity:Boolean,raw:Boolean,width:Number,writeFileWithTag:String};const fs=require("fs");var dir=new function(){this.scan=function(t){return""===t||"/"===t?(console.error("Error: directory to scan cannot be empty."),console.error('If you want to scan your script location, please use "dir2array.Scan(__dirname);"'),null):("/"!==t.slice(-1)&&(t+="/"),this.dirExists(t)?this.recursiveDir(t):void 0)},this.recursiveDir=function(t){const r=[];return fs.readdirSync(t).forEach(i=>{const n=t+i;if(this.isDir(n)){this.recursiveDir(n+"/").forEach(t=>r.push(t))}else r.push(n)}),r},this.isDir=function(t){return fs.lstatSync(t).isDirectory()},this.dirExists=function(t){try{return fs.lstatSync(t).isDirectory()}catch(t){return!1}}};const{createCanvas:createCanvas,loadImage:loadImage}=require("canvas");async function fromCanvas(t,r,i,n){const s=await loadImage(t),e=createCanvas(r,i);e.width=r,e.height=i;const o=e.getContext("2d");o.drawImage(s,0,0,r,i);const a=o.getImageData(0,0,r,i).data,c=[];let l;for(let t=0;t<i;t+=2)for(let i=0;i<r;i++){const s=4*(t*r+i),e=[a[s],a[s+1],a[s+2],a[s+3]];0===i&&(l=[],n?n(l):c.push(l)),n?n(e):l.push(e)}return c}const defaultCharList=" .,:;i1tfLCG08@",defaultColorCharList=" CGO08@",convertHtmlChars={" ":"&nbsp;"},rgbHtmlStr=(t,r,i)=>"rgb("+[t,r,i].join(",")+");";function toAscii({chars:t,isInvert:r,isHtmlColor:i,isBlock:n,isOpacity:s,isRaw:e}){let o=[];const a=(t||(i?defaultColorCharList:defaultCharList)).split("");function c(t){if(0===t.length){if(0===o.length)return;return void o.push(i?"<br/>":e?"":"\n")}const[c,l,u]=t,h=(.3*c+.59*l+.11*u)/255;let f=a.length-1-Math.round(h*(a.length-1));r&&(f=a.length-1-f);let g=a[f];i&&convertHtmlChars[g]&&(g=convertHtmlChars[g]);const d=function(t,[r,e,o,a]){if(!i)return;return"<span style='color:"+rgbHtmlStr(r,e,o)+(n?"background-color:"+rgbHtmlStr(r,e,o):"")+(s?"opacity:"+a/255+";":"")+"'>"+t+"</span>"}(g,t)||function(t,[r,i,n,s]){if(!e)return;return[t,[r,i,n,s]]}(g,t)||g;o.push(d)}function l(t){if(!Array.isArray(t))return e?JSON.stringify(o):o.join("");o=t}return{asciiChars:l,pixel:c,pixels:function(t){return t.forEach(t=>{t.forEach(t=>{c(t)}),c([])}),l()}}}async function asciiImgCanvasNodejs(t,r={}){if(!t||"string"!=typeof t)throw new TypeError("Invalid image source value: "+t);if("object"!=typeof r)throw new TypeError("Invalid options: "+r);const i=r.chars||null,n=!0===r.opacity,s=!0===r.block,e=!0===r.htmlColor,o=!0===r.invert,a=!0===r.raw,c=!1!==r.stream,l=r.height||200,u=r.width||200,h=toAscii({chars:i,isInvert:o,isBlock:s,isOpacity:n,isHtmlColor:e,isRaw:a});if(c)return await fromCanvas(t,u,l,h.pixel),h.asciiChars();const f=await fromCanvas(t,u,l);return h.pixels(f)}const fs$1=require("fs");async function main(){const t=process.argv.slice(2),[r,...i]=t;r||console.log("run: ascii-img {image-path} {options?}");const n=i.reduce((t,r)=>{const[i,n]=r.replace(/^--?/,"").split("=");return validateArgs[i]&&(t[i]=validateArgs[i](n)),t},{}),{writeFileWithTag:s}=n;let e;e=dir.dirExists(r)?dir.scan(r).filter(t=>t.match(/\.(jpe?g|png|svg)$/i)):[r];const o=await Promise.all(e.map(async t=>asciiImgCanvasNodejs(t,n).catch(console.log)));1!==e.length?void 0!==s?o.forEach((t,r)=>{fs$1.writeFileSync(`${e[r]}.${s}`,t,"utf-8")}):console.log(o.reduce((t,r,i)=>(t.push(r),t.push("\nFILENAME="+e[i]+":"),t),[]).join("\n")):console.log(o[0])}main();

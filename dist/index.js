"use strict";const{createCanvas:t,loadImage:r}=require("canvas");async function n(n,i,e,s){const o=await r(n),c=t(i,e);c.width=i,c.height=e;const a=c.getContext("2d");a.drawImage(o,0,0,i,e);const u=a.getImageData(0,0,i,e).data,h=[];let l;for(let t=0;t<e;t+=2)for(let r=0;r<i;r++){const n=4*(t*i+r),e=[u[n],u[n+1],u[n+2],u[n+3]];0===r&&(l=[],s?s(l):h.push(l)),s?s(e):l.push(e)}return h}const i={" ":"&nbsp;"},e=(t,r,n)=>"rgb("+[t,r,n].join(",")+");";function s({chars:t,isInvert:r,isHtmlColor:n,isBlock:s,isOpacity:o,isRaw:c}){let a=[];const u=(t||(n?" CGO08@":" .,:;i1tfLCG08@")).split("");function h(t){if(0===t.length){if(0===a.length)return;return void a.push(n?"<br/>":c?["",[]]:"\n")}const[h,l,f]=t,y=(.3*h+.59*l+.11*f)/255;let d=u.length-1-Math.round(y*(u.length-1));r&&(d=u.length-1-d);let p=u[d];n&&i[p]&&(p=i[p]);const w=function(t,[r,i,c,a]){if(!n)return;return"<span style='color:"+e(r,i,c)+(s?"background-color:"+e(r,i,c):"")+(o?"opacity:"+a/255+";":"")+"'>"+t+"</span>"}(p,t)||function(t,[r,n,i,e]){if(!c)return;return[t,[r,n,i,e]]}(p,t)||p;a.push(w)}function l(t){if(!Array.isArray(t))return c?JSON.stringify(a):a.join("");a=t}return{asciiChars:l,pixel:h,pixels:function(t){for(const r of t){for(const t of r)h(t);h([])}return l()}}}const o=require("fs");var c=new function(){this.scan=async function(t,r){if(""===t||"/"===t)return console.error("Error: directory to scan cannot be empty."),console.error('If you want to scan your script location, please use "dir2array.Scan(__dirname);"'),null;if("/"!==t.slice(-1)&&(t+="/"),!this.dirExists(t))return;const n=async t=>o.readdirSync(t).sort().reduce(async(i,e)=>{await i;const s=t+e;return this.dirExists(s)?n(s+"/"):r(s)},Promise.resolve());return n(t)},this.dirExists=function(t){try{return o.lstatSync(t).isDirectory()}catch{return!1}},this.fileExists=function(t){try{return o.existsSync(t)}catch{return!1}}};const{promisify:a}=require("util"),{URL:u}=require("url"),h=require("http"),l=require("https"),f=require("image-size");async function y({width:t,height:r},n){if(t&&r)return{width:t,height:r};let i=t,e=r;const s=await(async t=>{if(c.fileExists(t))return a(f)(t);const r=new u(t);return new Promise(n=>{(t.startsWith("https:")?l:h).get(r,t=>{const r=[];t.on("data",t=>{r.push(t)}).on("end",()=>{const t=Buffer.concat(r);n(f(t))})})})})(n);if(i||e||(i=100),i){const t=s.width/i;e=Math.round(s.height/t)}else{const t=s.height/e;i=Math.round(s.width/t)}return{width:i,height:e}}module.exports=async function(t,r={}){if(!t||"string"!=typeof t)throw new TypeError("Invalid image source value: "+t);if("object"!=typeof r)throw new TypeError("Invalid options: "+r);const i=r.chars||null,e=!0===r.opacity,o=!0===r.block,c=!0===r.htmlColor,a=!0===r.invert,u=!0===r.raw,h=!1!==r.stream,{width:l,height:f}=await y(r,t),d=s({chars:i,isInvert:a,isBlock:o,isOpacity:e,isHtmlColor:c,isRaw:u});if(h)return await n(t,l,f,d.pixel),d.asciiChars();const p=await n(t,l,f);return d.pixels(p)};

#!/usr/bin/env node
"use strict";var t={block:Boolean,chars:String,height:Number,htmlColor:Boolean,invert:Boolean,opacity:Boolean,raw:Boolean,width:Number,writeFileWithTag:String};const{createCanvas:r,loadImage:e}=require("canvas");async function n(t,n,i,o){const s=await e(t),c=r(n,i);c.width=n,c.height=i;const a=c.getContext("2d");a.drawImage(s,0,0,n,i);const u=a.getImageData(0,0,n,i).data,l=[];let h;for(let t=0;t<i;t+=2)for(let r=0;r<n;r++){const e=4*(t*n+r),i=[u[e],u[e+1],u[e+2],u[e+3]];0===r&&(h=[],o?o(h):l.push(h)),o?o(i):h.push(i)}return l}const i={" ":"&nbsp;"},o=(t,r,e)=>"rgb("+[t,r,e].join(",")+");";function s({chars:t,isInvert:r,isHtmlColor:e,isBlock:n,isOpacity:s,isRaw:c}){let a=[];const u=(t||(e?" CGO08@":" .,:;i1tfLCG08@")).split("");function l(t){if(0===t.length){if(0===a.length)return;return void a.push(e?"<br/>":c?["",[]]:"\n")}const[l,h,f]=t,p=(.3*l+.59*h+.11*f)/255;let y=u.length-1-Math.round(p*(u.length-1));r&&(y=u.length-1-y);let g=u[y];e&&i[g]&&(g=i[g]);const d=function(t,[r,i,c,a]){if(!e)return;return"<span style='color:"+o(r,i,c)+(n?"background-color:"+o(r,i,c):"")+(s?"opacity:"+a/255+";":"")+"'>"+t+"</span>"}(g,t)||function(t,[r,e,n,i]){if(!c)return;return[t,[r,e,n,i]]}(g,t)||g;a.push(d)}function h(t){if(!Array.isArray(t))return c?JSON.stringify(a):a.join("");a=t}return{asciiChars:h,pixel:l,pixels:function(t){for(const r of t){for(const t of r)l(t);l([])}return h()}}}const c=require("fs");var a=new function(){this.scan=async function(t,r){if(""===t||"/"===t)return console.error("Error: directory to scan cannot be empty."),console.error('If you want to scan your script location, please use "dir2array.Scan(__dirname);"'),null;if("/"!==t.slice(-1)&&(t+="/"),!this.dirExists(t))return;const e=async t=>c.readdirSync(t).sort().reduce(async(n,i)=>{await n;const o=t+i;return this.dirExists(o)?e(o+"/"):r(o)},Promise.resolve());return e(t)},this.dirExists=function(t){try{return c.lstatSync(t).isDirectory()}catch{return!1}},this.fileExists=function(t){try{return c.existsSync(t)}catch{return!1}}};const{promisify:u}=require("util"),{URL:l}=require("url"),h=require("http"),f=require("https"),p=require("image-size");async function y({width:t,height:r},e){if(t&&r)return{width:t,height:r};let n=t,i=r;const o=await(async t=>{if(a.fileExists(t))return u(p)(t);const r=new l(t);return new Promise(e=>{(t.startsWith("https:")?f:h).get(r,t=>{const r=[];t.on("data",t=>{r.push(t)}).on("end",()=>{const t=Buffer.concat(r);e(p(t))})})})})(e);if(n||i||(n=100),n){const t=o.width/n;i=Math.round(o.height/t)}else{const t=o.height/i;n=Math.round(o.width/t)}return{width:n,height:i}}async function g(t,r={}){if(!t||"string"!=typeof t)throw new TypeError("Invalid image source value: "+t);if("object"!=typeof r)throw new TypeError("Invalid options: "+r);const e=r.chars||null,i=!0===r.opacity,o=!0===r.block,c=!0===r.htmlColor,a=!0===r.invert,u=!0===r.raw,l=!1!==r.stream,{width:h,height:f}=await y(r,t),p=s({chars:e,isInvert:a,isBlock:o,isOpacity:i,isHtmlColor:c,isRaw:u});if(l)return await n(t,h,f,p.pixel),p.asciiChars();const g=await n(t,h,f);return p.pixels(g)}require("dotenv").config();const d=require("cors")(),w=require("compression")(),m=require("fastify")({logger:process.env.SERVER_LOG||!1}),[v,b]=process.argv.slice(2);function q(r){return Object.keys(r).reduce((e,n)=>(t[n]&&(e[n]=t[n](r[n])),e),{})}const x=Object.freeze({schema:{body:{type:"array"}}});m.use(d),m.use(w),m.get("/",()=>{const r=Object.keys(t);return{GET:"/img?url=&"+r.join("=&")+"= >>> response of text/html ",POST:"/imgs="+r.join("=&")+'= + application/json body of ["url1", "url2", "url3", ...]'}}),m.get("/img",(t,r)=>{const{url:e}=t.query,n=q(t.query);return r.type("text/html").code(200),function(t,r){return g(t,r)}(e,n)}),m.post("/imgs",x,(t,r)=>{const e=q(t.query),{body:n}=t;return r.type("application/json").code(200),function(t,r){return Promise.all(t.map(t=>g(t,r)))}(n,e)}),m.listen(Number(process.env.PORT||v)||3e3,process.env.IP||b||"0.0.0.0",(t,r)=>{if(t)throw console.log("START UP ERROR: "+t),t;console.log("Server listening on "+r)});
